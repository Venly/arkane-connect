name: 🏗️ Build
on:
  push:
    tags-ignore:
      - v*
    paths-ignore:
      - .github/**
  pull_request:
  workflow_dispatch:
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  actions: read
  checks: write
  contents: write
  deployments: read
  id-token: write
  issues: read
  discussions: read
  packages: read
  pages: read
  pull-requests: read
  repository-projects: read
  security-events: read
  statuses: read
run-name: 🏗️ Build ${{ github.ref_name	}}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.VENLY_GITHUB_ACTIONS_TOKEN }}

      - name: 🔍 Get Version
        uses: ./.github/actions/get_version

      - name: Check if last commit is a version bump
        id: check_is_version_bump
        if: (startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/hotfix-') || startsWith(github.ref, 'refs/heads/release-'))
        uses: ./.github/actions/check_is_version_bump

      - name: Not bumping the version or publishing to npm
        if: (steps.check_is_version_bump.outputs.is_version_bump == 'true')
        run: |
          #!/bin/bash
          set -x
          echo "Not bumping the version or publishing to npm because this is a version bump commit."

      - name: ⬆️ Bump Version
        if: ((steps.check_is_version_bump.outputs.is_version_bump != 'true') && (startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/hotfix-') || startsWith(github.ref, 'refs/heads/release-')))
        uses: ./.github/actions/bump_version
        with:
          token: ${{ secrets.VENLY_GITHUB_ACTIONS_TOKEN }}

      - name: 🛠️ Setup Node.js 16.x
        uses: actions/setup-node@v3
        id: node_setup
        with:
          node-version: 16.x

      - name: 🏗️ Build Node
        run: |
          #!/bin/bash
          set -x
          npm i
          npm run build

      - name: 📋 Log Current Version Before Publish
        if: (steps.check_is_version_bump.outputs.is_version_bump != 'true')
        run: |
          echo "Version before publishing: $(jq -r '.version' package.json)"

      - name: 🚀 Publish Npm
        if: ((steps.check_is_version_bump.outputs.is_version_bump != 'true') && (startsWith(github.ref, 'refs/heads/develop') || startsWith(github.ref, 'refs/heads/hotfix-') || startsWith(github.ref, 'refs/heads/release-')))
        uses: ./.github/actions/publish_npm
        with:
          npm_token: ${{ secrets.NPM_KEY }}
          token: ${{ secrets.VENLY_GITHUB_ACTIONS_TOKEN }}

      - name: 🔄 Merge Back
        if: startsWith(github.ref, 'refs/heads/hotfix-') || startsWith(github.ref, 'refs/heads/release-')
        uses: ./.github/actions/merge_back
        with:
          branch: ${{ github.ref_name }}
          token: ${{ secrets.VENLY_GITHUB_ACTIONS_TOKEN }}
